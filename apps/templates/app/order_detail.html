{% extends "app/base.html" %}
{% load static %}
{% load humanize %}
{% block order_detail %}

<div class="container my-5">
  <div class="card shadow-lg border-0 rounded-4 p-4">
    <h3 class="text-center fw-bold text-primary mb-4">
      ğŸ“¦ Chi tiáº¿t Ä‘Æ¡n hÃ ng #{{ order.id }}
    </h3>

    <!-- ThÃ´ng tin Ä‘Æ¡n hÃ ng -->
    <div class="row mb-4">
      <div class="col-md-6">
        <p><strong>NgÃ y Ä‘áº·t:</strong> {{ order.date_order|date:"d/m/Y H:i" }}</p>
        <p><strong>Tráº¡ng thÃ¡i:</strong>
          <span class="badge bg-{{ order.get_status_badge }}">
            {{ order.get_status_display }}
          </span>
        </p>
        <p><strong>Tá»•ng tiá»n:</strong>
          <span class="text-danger fw-bold">
            {{ order.get_cart_total|floatformat:0|intcomma }} â‚«
          </span>
        </p>
      </div>

      {% if user.is_staff %}
      <div class="col-md-6">
        <p><strong>KhÃ¡ch hÃ ng:</strong> {{ order.customer.username }}</p>
        <p><strong>Email:</strong> {{ order.customer.email }}</p>
        <p><strong>Cáº­p nháº­t gáº§n nháº¥t:</strong> {{ order.updated_at|date:"d/m/Y H:i" }}</p>
      </div>
      {% endif %}
    </div>

    <!-- Timeline tráº¡ng thÃ¡i -->
    <ul class="timeline mb-5">
      <li class="{% if order.status in 'confirmed shipping delivered completed' %}active{% endif %}">
        ğŸ“¦ <span>ÄÃ£ xÃ¡c nháº­n</span>
      </li>
      <li class="{% if order.status in 'shipping delivered completed' %}active{% endif %}">
        ğŸšš <span>Äang giao hÃ ng</span>
      </li>
      <li class="{% if order.status in 'delivered completed' %}active{% endif %}">
        âœ… <span>ÄÃ£ giao thÃ nh cÃ´ng</span>
      </li>
      <li class="{% if order.status == 'completed' %}active{% endif %}">
        ğŸ™Œ <span>HoÃ n táº¥t</span>
      </li>
      <li class="{% if order.status == 'cancelled' %}cancelled{% endif %}">
        âŒ <span>ÄÃ£ há»§y</span>
      </li>
    </ul>

    <!-- Sáº£n pháº©m -->
    <h5 class="fw-bold mb-3">ğŸ› Sáº£n pháº©m trong Ä‘Æ¡n</h5>
    <table class="table table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th>HÃ¬nh áº£nh</th>
          <th>Sáº£n pháº©m</th>
          <th>Sá»‘ lÆ°á»£ng</th>
          <th>GiÃ¡</th>
          <th>Tá»•ng</th>
        </tr>
      </thead>
      <tbody>
        {% for item in items %}
        <tr>
          <td>
            <img src="{{ item.product.ImageURL }}" alt="{{ item.product.name }}"
                 style="width:60px;height:60px;object-fit:cover;border-radius:8px;">
          </td>
          <td>{{ item.product.name }}</td>
          <td>{{ item.quantity }}</td>
          <td>{{ item.product.price|floatformat:0|intcomma }} â‚«</td>
          <td class="fw-bold text-danger">{{ item.get_total|floatformat:0|intcomma }} â‚«</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- NÃºt hÃ nh Ä‘á»™ng -->
    <div class="mt-4 text-center">
      {% if user.is_staff %}
        {# ADMIN: Giá»¯ nguyÃªn cÃ¡c nÃºt quáº£n lÃ½ tráº¡ng thÃ¡i #}
        {% if order.status == "confirmed" %}
          <a href="{% url 'update_order_status' order.id 'shipping' %}" class="btn btn-primary">ğŸšš Báº¯t Ä‘áº§u giao</a>
        {% endif %}
        {% if order.status == "shipping" %}
          <a href="{% url 'update_order_status' order.id 'delivered' %}" class="btn btn-success">ğŸ“¦ ÄÃ£ giao</a>
        {% endif %}
        {% if order.status not in "completed cancelled" %}
          <a href="{% url 'update_order_status' order.id 'cancelled' %}" class="btn btn-danger">âŒ Há»§y Ä‘Æ¡n</a>
        {% endif %}
      {% else %}
        {# USER: chá»‰ cÃ³ xÃ¡c nháº­n nháº­n hÃ ng hoáº·c há»§y vá»›i lÃ½ do #}
        {% if user == order.customer and order.status == "delivered" %}
          <a href="{% url 'confirm_received' order.id %}" class="btn btn-success">ğŸ™Œ XÃ¡c nháº­n Ä‘Ã£ nháº­n</a>
        {% endif %}

        {% if user == order.customer and order.status not in "completed cancelled" %}
          <!-- NÃºt má»Ÿ modal lÃ½ do há»§y -->
          <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#cancelReasonModal">
            âŒ Há»§y Ä‘Æ¡n
          </button>
        {% endif %}
      {% endif %}
    </div>
  </div>
</div>

<!-- Modal chá»n lÃ½ do há»§y (chá»‰ hiá»‡n cho user) -->
<div class="modal fade" id="cancelReasonModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" action="{% url 'cancel_order' order.id %}">
      {% csrf_token %}
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">LÃ½ do há»§y Ä‘Æ¡n hÃ ng</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <select name="reason" class="form-select" required>
            <option value="">-- Chá»n lÃ½ do --</option>
            <option value="wrong_order">Äáº·t nháº§m sáº£n pháº©m</option>
            <option value="not_needed">KhÃ´ng cáº§n ná»¯a</option>
            <option value="found_cheaper">TÃ¬m Ä‘Æ°á»£c chá»— ráº» hÆ¡n</option>
            <option value="other">KhÃ¡c</option>
          </select>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-danger">XÃ¡c nháº­n há»§y</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ÄÃ³ng</button>
        </div>
      </div>
    </form>
  </div>
</div>

<style>
  /* Timeline */
  .timeline {
    list-style:none;
    display:flex;
    justify-content:space-between;
    padding:0;
    margin:30px 0;
    position:relative;
  }
  .timeline::before {
    content:'';
    position:absolute;
    top:20px;
    left:0;
    right:0;
    height:4px;
    background:#e0e0e0;
    z-index:0;
  }
  .timeline li {
    text-align:center;
    position:relative;
    flex:1;
    font-size:14px;
    color:#888;
  }
  .timeline li span { display:block; margin-top:8px; }
  .timeline li.active { color:#2ecc71; font-weight:700; }
  .timeline li.active::after {
    background:#2ecc71;
    border:3px solid #27ae60;
  }
  .timeline li.cancelled { color:#e74c3c; font-weight:700; }
  .timeline li::after {
    content:'';
    width:20px;height:20px;
    background:#ccc;
    border-radius:50%;
    position:absolute;
    top:10px;left:50%;
    transform:translateX(-50%);
    z-index:1;
  }
</style>
{% endblock %}
